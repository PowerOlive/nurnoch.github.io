<!DOCTYPE html>
<html lang="zh">
<head>

        <title>编写高质量Python代码（3）——库</title>
        <meta charset="utf-8" />
        <link href="http://www.wengweitao.com/feeds\all.atom.xml" type="application/atom+xml" rel="alternate" title="wwt's blog Full Atom Feed" />
        <link href="http://www.wengweitao.com/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="wwt's blog Full RSS Feed" />
        <link href="http://www.wengweitao.com/feeds/du-shu-bi-ji.rss.xml" type="application/atom+xml" rel="alternate" title="wwt's blog Categories Atom Feed" />


        <!-- Mobile viewport optimized: j.mp/bplateviewport -->
        <meta name="viewport" content="width=device-width,initial-scale=1, maximum-scale=1">

        <meta name="sogou_site_verification" content="ia8yXdZS0p"/>
 

        <link rel="stylesheet" type="text/css" href="http://www.wengweitao.com/theme/gumby.css" />
        <link rel="stylesheet" type="text/css" href="http://www.wengweitao.com/theme/style.css" />
        <link rel="stylesheet" type="text/css" href="http://www.wengweitao.com/theme/pygment.css" />

        <script src="http://www.wengweitao.com/theme/js/libs/modernizr-2.6.2.min.js"></script>




</head>

<body id="index" class="home">


    <div class="container">

        <div class="row">

          <header id="banner" class="body">
                  <h1><a href="http://www.wengweitao.com/">wwt's blog <strong></strong></a></h1>
          </header><!-- /#banner -->

            <div id="navigation" class="navbar row">
              <a href="#" gumby-trigger="#navigation &gt; ul" class="toggle"><i class="icon-menu"></i></a>
             
              <ul class="columns">
                <li><a href="http://www.wengweitao.com/">首页</a></li>

                <li><a href="/categories.html">分类</a></li>
                <li><a href="/tags.html">标签</a></li>
                <li><a href="/archives.html">归档</a></li>
                <li><a href="/pages/about-me.html">关于我</a></li>

              </ul>
            </div>

<section id="content" class="body">

   <div class="row">
        <div class="eleven columns">


            <header>
              <h2 class="entry-title">
                <a href="http://www.wengweitao.com/bian-xie-gao-zhi-liang-pythondai-ma-3-ku.html" rel="bookmark"
                   title="Permalink to 编写高质量Python代码（3）——库">编写高质量Python代码（3）——库</a></h2>
           
            </header>
            <footer class="post-info">
              <abbr class="published" title="2015-04-08T22:58:00">
                Wed 08 April 2015
              </abbr>
              <address class="vcard author">By 
                <a class="url fn" href="http://www.wengweitao.com/author/wwt.html"> wwt</a>
              </address>
            </footer><!-- /.post-info -->
            <div class="entry-content">
              <blockquote>
<p>Python具有非常丰富的库，这篇文章介绍了常用库的使用和技巧。</p>
</blockquote>
<h3>建议36：掌握字符串的基本用法</h3>
<p>有个小技巧：</p>
<div class="highlight"><pre> <span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;SELECT *&#39;</span>
         <span class="s">&#39;FROM atable &#39;</span>
         <span class="s">&#39;WHERE afield=&quot;value&quot;&#39;</span><span class="p">)</span>
 <span class="n">s</span>
 <span class="s">&#39;SELECT *FROM atable WHERE afield=&quot;value&quot;&#39;</span>
</pre></div>


<p>以上利用了Python遇到未闭合的小括号时会自动将多行代码拼接为一行和把相邻的两个字符串字面量拼接在一起的特性做到的。（而如果使用三个引号会把换行符和空格都当做字符串的一部分）</p>
<p>Python字符串分为str和unicode两种。当需要判断变量是否为字符串时，应该使用</p>
<div class="highlight"><pre><span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">)</span>
</pre></div>


<p>Python提供了很多判定字符串的函数如：</p>
<ul>
<li>isalnum()</li>
<li>isalpha() </li>
<li>isdigit() </li>
<li>islower()</li>
<li>isupper()</li>
<li>isspace()</li>
<li>istitle() 首字母大写</li>
<li>startswith(prefix, start, end)</li>
<li>endswith</li>
</ul>
<p>查找和替换：</p>
<ul>
<li>count(sub, start, end )</li>
<li>find  找不到返回-1</li>
<li>index   找不到返回ValueError</li>
<li>rfind</li>
<li>rindex</li>
<li>replace(old, new, count)  最多替换count次。</li>
</ul>
<p>分切与连接：</p>
<ul>
<li>partition(seq), rpartition, : 返回一个3个元素的元组对象。sep左端，sep，sep右端</li>
<li>splitlines</li>
<li>split(sep, maxsplit), rsplit</li>
</ul>
<p>需要注意split()与split(' ')不同</p>
<div class="highlight"><pre><span class="n">In</span> <span class="p">[</span><span class="mi">3</span><span class="p">]:</span> <span class="s">&#39; hello   world!&#39;</span><span class="o">.</span><span class="n">split</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span> <span class="p">[</span><span class="s">&#39;hello&#39;</span><span class="p">,</span> <span class="s">&#39;world!&#39;</span><span class="p">]</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">5</span><span class="p">]:</span> <span class="s">&#39; hello   world!&#39;</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">)</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">5</span><span class="p">]:</span> <span class="p">[</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="s">&#39;hello&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="s">&#39;world!&#39;</span><span class="p">]</span>
</pre></div>


<p>变形：</p>
<ul>
<li>lower() </li>
<li>upper() </li>
<li>capitalize() </li>
<li>swapcase() </li>
<li>title()</li>
</ul>
<p>填充：</p>
<ul>
<li>center  居中</li>
<li>ljust   左对齐</li>
<li>rjust   右对齐)</li>
<li>zfill   字符0填充</li>
<li>expandtabs 制表符替换为适当数量的空格</li>
</ul>
<h3>建议37：按需选择sort()或者sorted()</h3>
<h4>1.相比sort, sorted()的使用更为广泛。</h4>
<div class="highlight"><pre><span class="nb">sorted</span><span class="p">(</span><span class="n">iterable</span><span class="p">,</span> <span class="nb">cmp</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">reverse</span><span class="p">)</span>
<span class="n">s</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="nb">cmp</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">reverse</span><span class="p">)</span>
</pre></div>


<p>cmp：用户定义的任何比较函数，函数的参数为两个可比较的元素（来自iterable或者list），返回-1, 0, 1，当第一个参数小于第二个参数则返回负数。
key：带一个参数的函数，用来为每个元素提取比较值，默认为None
reverse：排序结果是否反转</p>
<p>sorted可以作用于任意迭代对象，而sort()一般作用于列表。如sort((1,3,2))就抛出异常。</p>
<h4>2.当排序对象为列表时，二者适合的场景不同。</h4>
<p>sorted 返回一个排序后的列表，原有列表保持不变；而sort直接修改原有的列表，函数返回为None。
sort函数不需要复制原有列表，消耗内存较少，效率也比较高。</p>
<h4>3.传入参数key比参数cmp效率高。</h4>
<div class="highlight"><pre><span class="n">In</span> <span class="p">[</span><span class="mi">15</span><span class="p">]:</span> <span class="kn">from</span> <span class="nn">timeit</span> <span class="kn">import</span> <span class="n">Timer</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">16</span><span class="p">]:</span> <span class="n">Timer</span><span class="p">(</span><span class="n">stmt</span><span class="o">=</span><span class="s">&quot;sorted(xs, key=lambda x:x[1])&quot;</span><span class="p">,</span> <span class="n">setup</span><span class="o">=</span><span class="s">&quot;xs=range(100);xs=zip</span>
<span class="p">(</span><span class="n">xs</span><span class="p">,</span><span class="n">xs</span><span class="p">);</span><span class="s">&quot;).timeit(10000)    # 比较x[1]位置的值</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">16</span><span class="p">]:</span> <span class="mf">0.18814091348924744</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">17</span><span class="p">]:</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">17</span><span class="p">]:</span>
<span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
 <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
 <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
 <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
 <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
 <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
 <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
 <span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span>
 <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span>
 <span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">9</span><span class="p">)]</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">18</span><span class="p">]:</span> <span class="n">Timer</span><span class="p">(</span><span class="n">stmt</span><span class="o">=</span><span class="s">&quot;sorted(xs, cmp=lambda a,b: cmp(a[1],b[1]))&quot;</span><span class="p">,</span> <span class="n">setup</span><span class="o">=</span><span class="s">&quot;xs=rang</span>
<span class="n">e</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span><span class="n">xs</span><span class="o">=</span><span class="nb">zip</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span><span class="n">xs</span><span class="p">);</span><span class="s">&quot;).timeit(10000)  # 比较x[1]位置的值   cmp(x,y)当x &lt; y - &gt; -1</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">18</span><span class="p">]:</span> <span class="mf">0.2789308104491681</span>
</pre></div>


<h4>4.sorted功能非常强大，可以方便对不同数据结构进行排序。</h4>
<p>①对字典进行排序。</p>
<div class="highlight"><pre><span class="n">In</span> <span class="p">[</span><span class="mi">19</span><span class="p">]:</span> <span class="n">phonebook</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;Linda&#39;</span><span class="p">:</span> <span class="s">&#39;7750&#39;</span><span class="p">,</span> <span class="s">&#39;Bob&#39;</span><span class="p">:</span> <span class="s">&#39;9345&#39;</span><span class="p">,</span> <span class="s">&#39;Carol&#39;</span><span class="p">:</span> <span class="s">&#39;5834&#39;</span><span class="p">}</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">20</span><span class="p">]:</span> <span class="kn">from</span> <span class="nn">operator</span> <span class="kn">import</span> <span class="n">itemgetter</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">21</span><span class="p">]:</span> <span class="n">sorted_pb</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">phonebook</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">22</span><span class="p">]:</span> <span class="n">sorted_pb</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">22</span><span class="p">]:</span> <span class="p">[(</span><span class="s">&#39;Carol&#39;</span><span class="p">,</span> <span class="s">&#39;5834&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s">&#39;Linda&#39;</span><span class="p">,</span> <span class="s">&#39;7750&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s">&#39;Bob&#39;</span><span class="p">,</span> <span class="s">&#39;9345&#39;</span><span class="p">)]</span>
</pre></div>


<p>itemgetter获得指定位置的值。</p>
<p>②多维list排序。对多个字段进行排序。</p>
<div class="highlight"><pre><span class="n">In</span> <span class="p">[</span><span class="mi">23</span><span class="p">]:</span> <span class="n">gameresult</span> <span class="o">=</span> <span class="p">[[</span><span class="s">&#39;Bob&#39;</span><span class="p">,</span> <span class="mf">95.00</span><span class="p">,</span> <span class="s">&#39;A&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s">&#39;Alan&#39;</span><span class="p">,</span><span class="mf">86.0</span><span class="p">,</span><span class="s">&#39;C&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s">&#39;Mandy&#39;</span><span class="p">,</span> <span class="mf">82.5</span><span class="p">,</span><span class="s">&#39;A</span>
<span class="s">&#39;], [&#39;</span><span class="n">Rob</span><span class="s">&#39;, 86, &#39;</span><span class="n">E</span><span class="s">&#39;]]</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">24</span><span class="p">]:</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">gameresult</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="n">itemgetter</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">24</span><span class="p">]:</span>
<span class="p">[[</span><span class="s">&#39;Mandy&#39;</span><span class="p">,</span> <span class="mf">82.5</span><span class="p">,</span> <span class="s">&#39;A&#39;</span><span class="p">],</span>
 <span class="p">[</span><span class="s">&#39;Bob&#39;</span><span class="p">,</span> <span class="mf">95.0</span><span class="p">,</span> <span class="s">&#39;A&#39;</span><span class="p">],</span>
 <span class="p">[</span><span class="s">&#39;Alan&#39;</span><span class="p">,</span> <span class="mf">86.0</span><span class="p">,</span> <span class="s">&#39;C&#39;</span><span class="p">],</span>
 <span class="p">[</span><span class="s">&#39;Rob&#39;</span><span class="p">,</span> <span class="mi">86</span><span class="p">,</span> <span class="s">&#39;E&#39;</span><span class="p">]]</span>
</pre></div>


<p>先按等级，等级相同则按照分数高低排序。</p>
<p>③字典中混合list排序。
字典中的key或者值为列表，需要对列表中的某个位置的元素进行排序。</p>
<div class="highlight"><pre><span class="n">In</span> <span class="p">[</span><span class="mi">25</span><span class="p">]:</span> <span class="n">mydict</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&#39;Li&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s">&#39;M&#39;</span><span class="p">,</span><span class="mi">7</span><span class="p">],</span>
   <span class="o">....</span><span class="p">:</span>        <span class="s">&#39;Zhang&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s">&#39;E&#39;</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span>
   <span class="o">....</span><span class="p">:</span>        <span class="s">&#39;Weng&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s">&#39;W&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">]}</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">27</span><span class="p">]:</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">mydict</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">):</span> <span class="n">itemgetter</span><span class="p">(</span><span class="mi">1</span><span class="p">)(</span><span class="n">v</span><span class="p">))</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">27</span><span class="p">]:</span> <span class="p">[(</span><span class="s">&#39;Weng&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;W&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span> <span class="p">(</span><span class="s">&#39;Zhang&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;E&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">]),</span> <span class="p">(</span><span class="s">&#39;Li&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;M&#39;</span><span class="p">,</span> <span class="mi">7</span><span class="p">])]</span>
</pre></div>


<p>iteritems()返回的是（k，v），传入到函数中;  itemgetter(1)(v)取得v的第一个元素。</p>
<div class="highlight"><pre><span class="o">&gt;&gt;&gt;</span> <span class="n">itemgetter</span><span class="p">(</span><span class="mi">1</span><span class="p">)(</span><span class="s">&#39;ABCDEFG&#39;</span><span class="p">)</span>
<span class="s">&#39;B&#39;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">itemgetter</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">5</span><span class="p">)(</span><span class="s">&#39;ABCDEFG&#39;</span><span class="p">)</span>
<span class="p">(</span><span class="s">&#39;B&#39;</span><span class="p">,</span> <span class="s">&#39;D&#39;</span><span class="p">,</span> <span class="s">&#39;F&#39;</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">itemgetter</span><span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="bp">None</span><span class="p">))(</span><span class="s">&#39;ABCDEFG&#39;</span><span class="p">)</span>
<span class="s">&#39;CDEFG&#39;</span>
</pre></div>


<p>④List中混合字典排序
列表中每一个元素都为字典，需要针对字典的多个key值进行排序。</p>
<div class="highlight"><pre><span class="n">In</span> <span class="p">[</span><span class="mi">36</span><span class="p">]:</span> <span class="n">gameresult</span> <span class="o">=</span> <span class="p">[{</span><span class="s">&quot;name&quot;</span><span class="p">:</span><span class="s">&quot;Bob&quot;</span><span class="p">,</span> <span class="s">&quot;wins&quot;</span><span class="p">:</span><span class="mi">10</span><span class="p">,</span> <span class="s">&quot;losses&quot;</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;rating&quot;</span><span class="p">:</span><span class="mf">75.00</span><span class="p">},</span>
   <span class="o">....</span><span class="p">:</span>        <span class="p">{</span><span class="s">&quot;name&quot;</span><span class="p">:</span><span class="s">&quot;wwt&quot;</span><span class="p">,</span> <span class="s">&quot;wins&quot;</span><span class="p">:</span><span class="mi">99</span><span class="p">,</span> <span class="s">&quot;losses&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;rating&quot;</span><span class="p">:</span><span class="mf">100.0</span><span class="p">}]</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">37</span><span class="p">]:</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">gameresult</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">itemgetter</span><span class="p">(</span><span class="s">&quot;rating&quot;</span><span class="p">,</span><span class="s">&quot;name&quot;</span><span class="p">))</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">37</span><span class="p">]:</span>
<span class="p">[{</span><span class="s">&#39;losses&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="s">&#39;Bob&#39;</span><span class="p">,</span> <span class="s">&#39;rating&#39;</span><span class="p">:</span> <span class="mf">75.0</span><span class="p">,</span> <span class="s">&#39;wins&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">},</span>
 <span class="p">{</span><span class="s">&#39;losses&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="s">&#39;wwt&#39;</span><span class="p">,</span> <span class="s">&#39;rating&#39;</span><span class="p">:</span> <span class="mf">100.0</span><span class="p">,</span> <span class="s">&#39;wins&#39;</span><span class="p">:</span> <span class="mi">99</span><span class="p">}]</span>
</pre></div>


<p>按key为rating、name排序</p>
<h3>建议38：使用copy模块深拷贝对象</h3>
<div class="highlight"><pre><span class="n">In</span> <span class="p">[</span><span class="mi">38</span><span class="p">]:</span> <span class="kn">import</span> <span class="nn">copy</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">39</span><span class="p">]:</span> <span class="n">a</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">40</span><span class="p">]:</span> <span class="n">b</span> <span class="o">=</span> <span class="n">a</span>  <span class="c">#浅拷贝</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">41</span><span class="p">]:</span> <span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">42</span><span class="p">]:</span> <span class="n">b</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">42</span><span class="p">]:</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">43</span><span class="p">]:</span> <span class="n">a</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">43</span><span class="p">]:</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">44</span><span class="p">]:</span> <span class="n">c</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>  <span class="c">#深拷贝</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">49</span><span class="p">]:</span> <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">50</span><span class="p">]:</span> <span class="n">a</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">50</span><span class="p">]:</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">51</span><span class="p">]:</span> <span class="n">c</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">51</span><span class="p">]:</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
</pre></div>


<p>浅拷贝仅仅拷贝了对象的地址而不对对应地址所指向的具体内容进行拷贝。</p>
<h3>建议39：使用Counter进行计数统计</h3>
<p>计数统计有多重方法如：</p>
<ol>
<li>使用dict</li>
<li>使用defaultdict</li>
<li>使用set和list</li>
</ol>
<div class="highlight"><pre><span class="n">some_data</span> <span class="o">=</span> <span class="p">[</span><span class="o">...</span><span class="p">]</span>
<span class="n">count_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">some_data</span><span class="p">)</span>
<span class="n">count_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">count_set</span><span class="p">:</span>
    <span class="n">countlist</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">item</span><span class="p">,</span><span class="n">some_data</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">item</span><span class="p">)))</span>
<span class="nb">set</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</pre></div>


<p>还有更优雅地就是使用collections.Counter：</p>
<div class="highlight"><pre><span class="n">In</span> <span class="p">[</span><span class="mi">52</span><span class="p">]:</span> <span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Counter</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">53</span><span class="p">]:</span> <span class="n">some_data</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">656</span><span class="p">,</span><span class="mi">43</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">54</span><span class="p">]:</span> <span class="k">print</span> <span class="n">Counter</span><span class="p">(</span><span class="n">some_data</span><span class="p">)</span>
<span class="n">Counter</span><span class="p">({</span><span class="mi">2</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">43</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">656</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
</pre></div>


<p>使用elements可以获取key值：</p>
<div class="highlight"><pre><span class="n">In</span> <span class="p">[</span><span class="mi">56</span><span class="p">]:</span> <span class="nb">list</span><span class="p">(</span><span class="n">Counter</span><span class="p">(</span><span class="n">some_data</span><span class="p">)</span><span class="o">.</span><span class="n">elements</span><span class="p">())</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">56</span><span class="p">]:</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">43</span><span class="p">,</span> <span class="mi">656</span><span class="p">]</span>
</pre></div>


<p>使用most_common找出前N个频率最高的元素：</p>
<div class="highlight"><pre><span class="n">In</span> <span class="p">[</span><span class="mi">57</span><span class="p">]:</span> <span class="n">Counter</span><span class="p">(</span><span class="n">some_data</span><span class="p">)</span><span class="o">.</span><span class="n">most_common</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">57</span><span class="p">]:</span> <span class="p">[(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">)]</span>
</pre></div>


<p>当访问不存在的元素时，返回的是0，而不是KeyError:</p>
<div class="highlight"><pre><span class="p">(</span><span class="n">Counter</span><span class="p">(</span><span class="n">some_data</span><span class="p">)[</span><span class="s">&#39;a&#39;</span><span class="p">])</span>
<span class="mi">0</span>
</pre></div>


<p>update和subtract:</p>
<div class="highlight"><pre><span class="n">In</span> <span class="p">[</span><span class="mi">58</span><span class="p">]:</span> <span class="n">c</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="s">&quot;success&quot;</span><span class="p">)</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">59</span><span class="p">]:</span> <span class="k">print</span> <span class="n">c</span>
<span class="n">Counter</span><span class="p">({</span><span class="s">&#39;s&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s">&#39;c&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&#39;e&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&#39;u&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">60</span><span class="p">]:</span> <span class="n">c</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s">&quot;sucessfully&quot;</span><span class="p">)</span> <span class="c"># 累加而不是替换</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">61</span><span class="p">]:</span> <span class="n">c</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">61</span><span class="p">]:</span> <span class="n">Counter</span><span class="p">({</span><span class="s">&#39;s&#39;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span> <span class="s">&#39;c&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s">&#39;u&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s">&#39;e&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&#39;l&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&#39;f&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&#39;y&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">63</span><span class="p">]:</span> <span class="n">c</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="s">&quot;successfully&quot;</span><span class="p">)</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">64</span><span class="p">]:</span> <span class="n">c</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">64</span><span class="p">]:</span> <span class="n">Counter</span><span class="p">({</span><span class="s">&#39;s&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s">&#39;c&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&#39;e&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&#39;u&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&#39;f&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#39;l&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#39;y&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span>
</pre></div>


<p>关于Counter的更深入应用，可以阅读我的另一篇<a href="http://www.wengweitao.com/pythonrong-qi-counterde-shi-yong.html">文章</a>。</p>
<h3>建议40：深入掌握ConfigParser</h3>
<p>配置文件的意义在于用户不需要修改代码，就可以改变应用程序的行为。
ConfigParser有几个地方需要提一下：</p>
<ol>
<li>
<p>getboolean函数，根据一定的规则将配置项的值转换为布尔值。
[section1]
option1=0
当调用getboolean('section1','option1')时，返回的值是False。</p>
</li>
<li>
<p>配置项的查找规则。
有一个[DEFAULT]节，当读取的配置项不在指定的节里时，会在[DEFAULT]节中查找。</p>
</li>
<li>
<p>支持字符串格式化的类似语法</p>
</li>
</ol>
<div class="highlight"><pre><span class="n">cat</span> <span class="n">format</span><span class="p">.</span><span class="n">conf</span>
</pre></div>


<div class="highlight"><pre><span class="p">[</span><span class="n">DEFAULT</span><span class="p">]</span>
<span class="n">conn_str</span> <span class="o">=</span> <span class="o">%</span><span class="p">(</span><span class="n">dnb</span><span class="p">)</span><span class="n">s</span><span class="p">:</span><span class="o">//%</span><span class="p">(</span><span class="n">user</span><span class="p">)</span><span class="n">s</span><span class="p">:</span><span class="o">%</span><span class="p">(</span><span class="n">pw</span><span class="p">)</span><span class="n">s</span><span class="err">@</span><span class="o">%</span><span class="p">(</span><span class="n">host</span><span class="p">)</span><span class="n">s</span><span class="p">:</span><span class="o">%</span><span class="p">(</span><span class="n">port</span><span class="p">)</span><span class="n">s</span><span class="o">/%</span><span class="n">s</span><span class="p">(</span><span class="n">db</span><span class="p">)</span><span class="n">s</span>
<span class="n">dbn</span> <span class="o">=</span> <span class="n">mysql</span>
<span class="n">user</span> <span class="o">=</span> <span class="n">root</span>
<span class="n">host</span> <span class="o">=</span> <span class="n">localhost</span>
<span class="n">port</span> <span class="o">=</span> <span class="mi">3306</span>
<span class="p">[</span><span class="n">db1</span><span class="p">]</span>
<span class="n">user</span> <span class="o">=</span> <span class="n">aaa</span>
<span class="n">pw</span> <span class="o">=</span> <span class="n">ppp</span>
<span class="n">db</span> <span class="o">=</span> <span class="n">exmaple</span>
<span class="p">[</span><span class="n">db2</span><span class="p">]</span>
<span class="n">user</span> <span class="o">=</span> <span class="n">bbb</span>
<span class="n">pw</span> <span class="o">=</span> <span class="n">ccc</span>
<span class="n">db</span> <span class="o">=</span> <span class="n">example</span>
<span class="kn">import</span> <span class="nn">ConfigParser</span>
<span class="n">conf</span> <span class="o">=</span> <span class="n">ConfigParser</span><span class="o">.</span><span class="n">ConfigParser</span><span class="p">()</span>
<span class="n">conf</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s">&#39;foramt.conf&#39;</span><span class="p">)</span>
<span class="k">print</span> <span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;db1&#39;</span><span class="p">,</span><span class="s">&#39;conn_str&#39;</span><span class="p">)</span>
</pre></div>


<p>以上配置可以根据不同配置获取不同数据库配置相应的连接字符串。</p>
<h3>建议41：使用argparse处理命令行参数</h3>
<p>Pythonista有好几种方案，标准库中留下来的getopt, optparse和argparse。
其中argparse是最强大的。</p>
<div class="highlight"><pre><span class="n">In</span> <span class="p">[</span><span class="mi">65</span><span class="p">]:</span> <span class="kn">import</span> <span class="nn">argparse</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">66</span><span class="p">]:</span> <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">67</span><span class="p">]:</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-o&#39;</span><span class="p">,</span><span class="s">&#39;--output&#39;</span><span class="p">)</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">67</span><span class="p">]:</span> <span class="n">_StoreAction</span><span class="p">(</span><span class="n">option_strings</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;-o&#39;</span><span class="p">,</span> <span class="s">&#39;--output&#39;</span><span class="p">],</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;output&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="n">No</span>
<span class="n">ne</span><span class="p">,</span> <span class="n">const</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">68</span><span class="p">]:</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-v&#39;</span><span class="p">,</span><span class="n">dest</span><span class="o">=</span><span class="s">&#39;verbose&#39;</span><span class="p">,</span><span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">)</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">68</span><span class="p">]:</span> <span class="n">_StoreTrueAction</span><span class="p">(</span><span class="n">option_strings</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;-v&#39;</span><span class="p">],</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;verbose&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">const</span><span class="o">=</span>
<span class="bp">True</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">69</span><span class="p">]:</span> <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">70</span><span class="p">]:</span> <span class="n">args</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">70</span><span class="p">]:</span> <span class="n">Namespace</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</pre></div>


<p>现在又出现了docopt，比argparse更先进更易用的命令行参数处理器。（但是，还不是标准库的一部分）</p>
<h3>建议42：使用pandas处理大型CSV文件</h3>
<p>CSV(Comma Seperated Values)作为一种逗号分隔型值的纯文本格式文件，实际中经常用到。Python提供了处理csv的API：</p>
<p>1.reader( csvfile, dialect='excel', fmtparam  ) 用于csv文件的读取，返回reader对象。当dialect设置为excel时，默认Dialect值如下：</p>
<div class="highlight"><pre><span class="k">class</span> <span class="nc">excel</span><span class="p">(</span><span class="n">Dialect</span><span class="p">):</span>
    <span class="n">delimiter</span> <span class="o">=</span> <span class="s">&#39;,&#39;</span>  <span class="c"># 单个字符，用于分隔字段，常见的有, | ;</span>
    <span class="n">quotechar</span> <span class="o">=</span> <span class="s">&#39;&quot;&#39;</span>  <span class="c"># 用于对特殊符号加引号</span>
    <span class="n">doublequote</span> <span class="o">=</span> <span class="bp">True</span>  <span class="c"># quotechar出现时候表现形式</span>
    <span class="n">skipinitialspace</span> <span class="o">=</span> <span class="bp">False</span> <span class="c"># true是delimiter后面的空格会忽略</span>
    <span class="n">lineterminator</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\r\n</span><span class="s">&#39;</span>  <span class="c">#行结束符</span>
    <span class="n">quoting</span> <span class="o">=</span> <span class="n">QUOTE_MINIMAL</span> <span class="c"># 是否在字段前加引号</span>
</pre></div>


<p>2.csv.writer(csvfile, dialect=‘excel’, **fmtparams)用于写入CSV文件，参数同上。</p>
<p>3.csv.DictReader(csvfile, fieldnames=None, restkey=None, restval=None, dialect="excel", <em>args, </em>*kwds)
同reader方法类似，不同的是把信息映射到一个字典中去。</p>
<p>4.csv.DictWriter(csvfile, fieldnames, restval='', extrasaction='raise', dialect='excel', <em>args, </em>*kwds)用于支持字典写入。</p>
<p>CSV模块使用非常方便(import csv)，但如果要处理的CSV文件大小上百MB或者几个GB，那么csv模块就应付不来了。
下面做一个实验，临时创建一个1GB的CSV文件并将其加载到内存中：</p>
<div class="highlight"><pre><span class="n">In</span> <span class="p">[</span><span class="mi">13</span><span class="p">]:</span> <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;large.csv&#39;</span><span class="p">,</span><span class="s">&#39;wb&#39;</span><span class="p">)</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">14</span><span class="p">]:</span> <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">1073741824</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>   <span class="c"># 创建大文件的技巧</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">15</span><span class="p">]:</span> <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\0</span><span class="s">&quot;</span><span class="p">)</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">16</span><span class="p">]:</span> <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">17</span><span class="p">]:</span> <span class="kn">import</span> <span class="nn">os</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">18</span><span class="p">]:</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="s">&quot;large.csv&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">st_size</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">18</span><span class="p">]:</span> <span class="il">1073741824L</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">19</span><span class="p">]:</span> <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">&quot;large.csv&quot;</span><span class="p">,</span><span class="s">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">csvfile</span><span class="p">:</span>
   <span class="o">....</span><span class="p">:</span>     <span class="n">mycsv</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">csvfile</span><span class="p">,</span><span class="n">delimiter</span><span class="o">=</span><span class="s">&#39;;&#39;</span><span class="p">)</span>
   <span class="o">....</span><span class="p">:</span>     <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">mycsv</span><span class="p">:</span>
   <span class="o">....</span><span class="p">:</span>         <span class="k">print</span> <span class="n">row</span>
   <span class="o">....</span><span class="p">:</span>
</pre></div>


<p>运行后会出现MemoryError。</p>
<p>所以应该使用pandas。其支持两种数据结构——Series和DataFrame是数据处理的基础。</p>
<ol>
<li>Series:是一种类似数组的带索引的一维数据结构。通过obj.values()和obj.index()可以分别获取值和索引。</li>
<li>DataFrame：类似一个二维数据结构，支持行和列的索引。</li>
</ol>
<p>pandas中处理csv文件的函数主要为read_csv()和to_csv()，前者读取csv文件内容并返回DataFrame,后者则相反。
①可以指定读取部分列和文件的行数
②设置CSV文件与excel兼容
③对文件进行分块处理并返回一个可迭代的对象
④当文件格式相似的时候，支持多个文件合并处理。</p>
<p>pandas处理非常灵活，而且底层使用Cython实现速度较快，在专业的数据处理与分析领域，如金融等行业已经得到广泛应用。</p>
<h3>建议43：一般情况下使用ElementTree解析XML</h3>
<p>xml.dom.minidom和xml.sax是Python解析XML文件最为人们熟知的两个模块了。从Python2.5开始ElementTree成为标准模块，cElementTree是Cython实现，速度更快，消耗内存更少，实际使用应尽量使用cElementTree. 具有以下特性：</p>
<ul>
<li>使用简单。每一个元素的属性以字典形式表示</li>
<li>内存消耗明显低于DOM解析。避免将整个XML文件加载到内存中</li>
<li>支持XPath查询</li>
</ul>
<p>如果XML文件在GB级别，那么第三方的lxml是更好的选择。</p>
<p>ElementTree主要方法：</p>
<ul>
<li>getroot()</li>
<li>find(match)</li>
<li>findall(match)</li>
<li>findtext(match, default=None)</li>
<li>iter(tag)</li>
</ul>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">xml.etree.ElementTree</span> <span class="kn">as</span> <span class="nn">ET</span>
<span class="n">tree</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">ElementTree</span><span class="p">(</span><span class="nb">file</span><span class="o">=</span><span class="s">&quot;test.xml&quot;</span><span class="p">)</span>
<span class="n">root</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">getroot</span><span class="p">()</span>
<span class="k">print</span> <span class="n">root</span>
<span class="k">print</span> <span class="n">root</span><span class="o">.</span><span class="n">tag</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">root</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s">&quot;system/purpose&quot;</span><span class="p">)</span>
    <span class="k">print</span> <span class="n">i</span><span class="o">.</span><span class="n">text</span>
</pre></div>


<h3>建议44：理解模块pickle优劣</h3>
<p><strong>序列化的场景很常见</strong>：</p>
<ul>
<li>在磁盘上保存当前程序的状态数据以便重启的时候能够重新加载</li>
<li>多用户或者分布式操作系统中数据结构的网络传输时，可以将数据序列化后发送给一个可信网络对端，接收后反序列化后恢复相同的对象。</li>
<li>session和cache的存储等。</li>
</ul>
<p><strong>序列化</strong>：简单地说就是把内存中数据结构在不丢失其身份和类型信息的情况下转成对象的文本或者二进制表示的过程。对象序列化后的形式经过反序列化过程应该能够恢复为原有的对象。
Python有很多支持序列化的模块，如pickle，json，marshal和shelve等。</p>
<p>pickle是最通用的序列化模块。它的C语言实现为cPickle，其速度为pickle的1000倍。
pickle最主要的两个函数时dump()和load()，分别进行序列化和反序列化。</p>
<p>pickle.dump(obj, file, protocol )序列化数据到一个文件描述符，obj表示需要序列化的对象
load(file): 反序列化。</p>
<div class="highlight"><pre><span class="n">In</span> <span class="p">[</span><span class="mi">20</span><span class="p">]:</span> <span class="kn">import</span> <span class="nn">cPickle</span> <span class="kn">as</span> <span class="nn">pickle</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">21</span><span class="p">]:</span> <span class="n">my_data</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;name&quot;</span><span class="p">:</span> <span class="s">&quot;Python&quot;</span><span class="p">,</span> <span class="s">&quot;type&quot;</span><span class="p">:</span> <span class="s">&quot;Language&quot;</span><span class="p">,</span> <span class="s">&quot;version&quot;</span><span class="p">:</span> <span class="s">&quot;2.7.5&quot;</span><span class="p">}</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">22</span><span class="p">]:</span> <span class="n">fp</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&quot;picklefile.dat&quot;</span><span class="p">,</span><span class="s">&quot;wb&quot;</span><span class="p">)</span>  <span class="c"># 打开要写入的文件</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">23</span><span class="p">]:</span> <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">my_data</span><span class="p">,</span> <span class="n">fp</span><span class="p">)</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">24</span><span class="p">]:</span> <span class="n">fp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">25</span><span class="p">]:</span> <span class="n">fp</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&quot;picklefile.dat&quot;</span><span class="p">,</span><span class="s">&quot;rb&quot;</span><span class="p">)</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">26</span><span class="p">]:</span> <span class="n">out</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">27</span><span class="p">]:</span> <span class="k">print</span> <span class="n">out</span>
<span class="p">{</span><span class="s">&#39;version&#39;</span><span class="p">:</span> <span class="s">&#39;2.7.5&#39;</span><span class="p">,</span> <span class="s">&#39;type&#39;</span><span class="p">:</span> <span class="s">&#39;Language&#39;</span><span class="p">,</span> <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="s">&#39;Python&#39;</span><span class="p">}</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">28</span><span class="p">]:</span> <span class="n">fp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>


<p><strong>pickle具有的特性</strong>：</p>
<ul>
<li>接口简单，容易使用。dump和load</li>
<li>存储格式具有通用性。能够被不同平台的Python解析器共享。</li>
<li>支持数据类型广泛</li>
<li>pickle模块式可以扩展的。对于不可序列化的对象，如sockets、文件句柄、数据库连接等，可以通过特殊方法__getstate__()和__setstate__()来返回实例在被pickle时的状态。</li>
<li>能够自动维护对象间的引用。</li>
</ul>
<div class="highlight"><pre><span class="n">In</span> <span class="p">[</span><span class="mi">29</span><span class="p">]:</span> <span class="n">a</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;a&#39;</span><span class="p">,</span><span class="s">&#39;b&#39;</span><span class="p">]</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">30</span><span class="p">]:</span> <span class="n">b</span> <span class="o">=</span> <span class="n">a</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">31</span><span class="p">]:</span> <span class="n">b</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;c&#39;</span><span class="p">)</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">32</span><span class="p">]:</span> <span class="n">b</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">32</span><span class="p">]:</span> <span class="p">[</span><span class="s">&#39;a&#39;</span><span class="p">,</span> <span class="s">&#39;b&#39;</span><span class="p">,</span> <span class="s">&#39;c&#39;</span><span class="p">]</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">33</span><span class="p">]:</span> <span class="n">a</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">33</span><span class="p">]:</span> <span class="p">[</span><span class="s">&#39;a&#39;</span><span class="p">,</span> <span class="s">&#39;b&#39;</span><span class="p">,</span> <span class="s">&#39;c&#39;</span><span class="p">]</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">34</span><span class="p">]:</span> <span class="n">p</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">((</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">))</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">35</span><span class="p">]:</span> <span class="n">a1</span><span class="p">,</span> <span class="n">b1</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">36</span><span class="p">]:</span> <span class="n">a1</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">36</span><span class="p">]:</span> <span class="p">[</span><span class="s">&#39;a&#39;</span><span class="p">,</span> <span class="s">&#39;b&#39;</span><span class="p">,</span> <span class="s">&#39;c&#39;</span><span class="p">]</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">37</span><span class="p">]:</span> <span class="n">b1</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">37</span><span class="p">]:</span> <span class="p">[</span><span class="s">&#39;a&#39;</span><span class="p">,</span> <span class="s">&#39;b&#39;</span><span class="p">,</span> <span class="s">&#39;c&#39;</span><span class="p">]</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">38</span><span class="p">]:</span> <span class="n">a1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;d&#39;</span><span class="p">)</span>  <span class="c"># 反序列化后对a1对象的修改仍然会影响到b1</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">39</span><span class="p">]:</span> <span class="n">b1</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">39</span><span class="p">]:</span> <span class="p">[</span><span class="s">&#39;a&#39;</span><span class="p">,</span> <span class="s">&#39;b&#39;</span><span class="p">,</span> <span class="s">&#39;c&#39;</span><span class="p">,</span> <span class="s">&#39;d&#39;</span><span class="p">]</span>
</pre></div>


<p><strong>pickle也有一些限制</strong>：
- 不能保证操作的原子性。也就是说pickle调用中如果发生异常， 可能部分数据已经保存。
- pickle存在安全性问题。pickle.loads('cmd')
- pickle协议是Python特定的，不同语言兼容性难以保证。</p>
<h3>建议45：序列化的另一个不错的选择——JSON</h3>
<p>Python有一系列模块提供对JSON格式的支持，如simplejson, cjson, yajl, ujson, 2.6后又引入了标准库JSON。cjson是用C语言实现，yajl是Cython版本的JSON实现。
simplejson与标准库JSON的区别不大，但更新可能更快，在实际使用中将这两者结合采用如下的import方法：</p>
<div class="highlight"><pre><span class="k">try</span><span class="p">:</span> 
    <span class="kn">import</span> <span class="nn">simplejson</span> <span class="kn">as</span> <span class="nn">json</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span> 
    <span class="kn">import</span> <span class="nn">json</span>
</pre></div>


<p>JSON的常用方法与pickle类似，dump/dumps序列化，load/loads反序列化。 </p>
<p>相比pickle，json具有以下优势：</p>
<ul>
<li>使用简单，支持多种数据类型。</li>
<li>名称/ 值对的集合</li>
<li>值的有序列表</li>
<li>存储格式可读性更为友好，容易修改。dumps函数提供了一个参数indent使生成的json文件可读性更好，0意味着每个值单独一行；大于0的数字表示使用这个数字的空格来缩进嵌套结构。但这个是以文件大小变大为代价的。</li>
<li>json支持跨平台跨语言操作，能够轻易被其他语言解析。</li>
<li>具有较强的扩展性。提供了编码(JSONEncoder)和解码类（JSONDecoder）以便用户对其默认不支持的序列化类型进行扩展。</li>
</ul>
<p>但是Python中标准模块json的性能比pickle稍逊。性能要求高的话，还是选择cPickle。</p>
<h3>建议46：使用traceback获取栈信息</h3>
<p>traceback会输出完整的栈信息，有利于开发人员快速找到异常发生时的现场信息。
tracback.print_exc()打印出：错误类型，错误对应的值已经具体的trace信息，包括文件名、具体行号、函数名已经对应的代码。</p>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">traceback</span>
<span class="n">gList</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;a&#39;</span><span class="p">,</span><span class="s">&#39;b&#39;</span><span class="p">,</span><span class="s">&#39;c&#39;</span><span class="p">,</span><span class="s">&#39;d&#39;</span><span class="p">,</span><span class="s">&#39;f&#39;</span><span class="p">,</span><span class="s">&#39;g&#39;</span><span class="p">,</span><span class="s">&#39;e&#39;</span><span class="p">]</span>
<span class="k">def</span> <span class="nf">f</span><span class="p">():</span>
    <span class="n">gList</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">g</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">g</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">h</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">h</span><span class="p">():</span>
    <span class="k">del</span> <span class="n">gList</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">i</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">i</span><span class="p">():</span>
    <span class="n">gList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;i&#39;</span><span class="p">)</span>
    <span class="k">print</span> <span class="n">gList</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">f</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">IndexError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&#39;sorry, out of range&#39;</span>
        <span class="k">print</span> <span class="n">ex</span>
        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
</pre></div>


<p>输出结果：</p>
<div class="highlight"><pre><span class="nx">sorry</span><span class="p">,</span> <span class="nb">out</span> <span class="nx">of</span> <span class="nb">range</span>
<span class="nb">list</span> <span class="nb">index</span> <span class="nb">out</span> <span class="nx">of</span> <span class="nb">range</span>
<span class="nx">Traceback</span> <span class="p">(</span><span class="nx">most</span> <span class="nx">recent</span> <span class="nb">call</span> <span class="nb">last</span><span class="p">):</span>
  <span class="nb">File</span> <span class="s2">&quot;trace_back.py&quot;</span><span class="p">,</span> <span class="nb">line</span> <span class="mi">17</span><span class="p">,</span> <span class="k">in</span> <span class="o">&lt;</span><span class="nx">module</span><span class="o">&gt;</span>
    <span class="nb">f</span><span class="p">()</span>
  <span class="nb">File</span> <span class="s2">&quot;trace_back.py&quot;</span><span class="p">,</span> <span class="nb">line</span> <span class="mi">5</span><span class="p">,</span> <span class="k">in</span> <span class="nb">f</span>
    <span class="k">return</span> <span class="nx">g</span><span class="p">()</span>
  <span class="nb">File</span> <span class="s2">&quot;trace_back.py&quot;</span><span class="p">,</span> <span class="nb">line</span> <span class="mi">7</span><span class="p">,</span> <span class="k">in</span> <span class="nx">g</span>
    <span class="k">return</span> <span class="nx">h</span><span class="p">()</span>
  <span class="nb">File</span> <span class="s2">&quot;trace_back.py&quot;</span><span class="p">,</span> <span class="nb">line</span> <span class="mi">10</span><span class="p">,</span> <span class="k">in</span> <span class="nx">h</span>
    <span class="k">return</span> <span class="nx">i</span><span class="p">()</span>
  <span class="nb">File</span> <span class="s2">&quot;trace_back.py&quot;</span><span class="p">,</span> <span class="nb">line</span> <span class="mi">13</span><span class="p">,</span> <span class="k">in</span> <span class="nx">i</span>
    <span class="nx">print</span> <span class="nx">gList</span><span class="err">[</span><span class="mi">7</span><span class="cp">]</span>
IndexError: list index out of range
</pre></div>


<h3>建议47：使用logging记录日志信息</h3>
<p>仅仅将栈信息输出到控制台远远不够，更为常见的做法是使用日志保存程序运行过程中的相关信息，如运行时间、描述信息以及错误或者异常发生时候的特定上下文信息。Python自带了logging模块提供了日志功能。</p>
<p>logger分为5个级别，包含4个主要对象：</p>
<ol>
<li>logger：程序信息输出的接口，分散在不同代码中，使得程序可以再运行的时候记录相应的信息，并根据设置的日志级别或者filter来决定哪些信息需要输出，并将这些信息方法到其关联的handler。</li>
<li>handler。处理信息的输出，可以输出到控制台、文件或者网络。</li>
<li>Formatter。决定log信息的格式</li>
<li>Filter。决定哪些信息需要输出。</li>
</ol>
<p>下面是一个使用logging的例子：</p>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="n">gList</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;a&#39;</span><span class="p">,</span><span class="s">&#39;b&#39;</span><span class="p">,</span><span class="s">&#39;c&#39;</span><span class="p">,</span><span class="s">&#39;d&#39;</span><span class="p">,</span><span class="s">&#39;f&#39;</span><span class="p">,</span><span class="s">&#39;g&#39;</span><span class="p">,</span><span class="s">&#39;e&#39;</span><span class="p">]</span>
<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span>  <span class="c"># configure log output formatter</span>
        <span class="n">level</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="s">&#39;log.txt&#39;</span><span class="p">,</span>
        <span class="n">filemode</span> <span class="o">=</span> <span class="s">&#39;w&#39;</span><span class="p">,</span>
        <span class="n">format</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%(asctime)s</span><span class="s"> </span><span class="si">%(filename)s</span><span class="s">[line:</span><span class="si">%(lineno)d</span><span class="s">] </span><span class="si">%(levelname)s</span><span class="s"> </span><span class="si">%(message)s</span><span class="s">&#39;</span><span class="p">,)</span>
<span class="k">def</span> <span class="nf">f</span><span class="p">():</span>
    <span class="n">gList</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;[INFO]:calling method g() in f()&#39;</span><span class="p">)</span> <span class="c"># normal message</span>
    <span class="k">return</span> <span class="n">g</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">g</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">h</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">h</span><span class="p">():</span>
    <span class="k">del</span> <span class="n">gList</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">i</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">i</span><span class="p">():</span>
    <span class="n">gList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;i&#39;</span><span class="p">)</span>
    <span class="k">print</span> <span class="n">gList</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Information during calling f():&#39;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">f</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">IndexError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&#39;sorry, out of range&#39;</span>
        <span class="c">#traceback.print_exc()</span>
        <span class="n">ty</span><span class="p">,</span><span class="n">tv</span><span class="p">,</span><span class="n">tb</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;[ERROR]:Sorry,Exception occured.&quot;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s">&#39;object info:</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">ex</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s">&#39;Error Type:{0}, Error information:{1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ty</span><span class="p">,</span><span class="n">tv</span><span class="p">))</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_tb</span><span class="p">(</span><span class="n">tb</span><span class="p">)))</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>


<p>输出log到log.txt，内容如下：</p>
<div class="highlight"><pre><span class="mi">2014</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">11</span> <span class="mi">20</span><span class="p">:</span><span class="mi">50</span><span class="p">:</span><span class="mi">55</span><span class="p">,</span><span class="mi">684</span> <span class="nx">trace_back.py</span><span class="err">[</span><span class="nb">line</span><span class="p">:</span><span class="mi">25</span><span class="cp">]</span> DEBUG Information during calling f():
2014-12-11 20:50:55,684 trace_back.py<span class="cp">[</span><span class="nb">line</span><span class="p">:</span><span class="mi">13</span><span class="cp">]</span> INFO <span class="cp">[</span><span class="nx">INFO</span><span class="cp">]</span>:calling method g() in f()
2014-12-11 20:50:55,684 trace_back.py<span class="cp">[</span><span class="nb">line</span><span class="p">:</span><span class="mi">32</span><span class="cp">]</span> ERROR <span class="cp">[</span><span class="nb">ERROR</span><span class="cp">]</span>:Sorry,Exception occured.
2014-12-11 20:50:55,684 trace_back.py<span class="cp">[</span><span class="nb">line</span><span class="p">:</span><span class="mi">33</span><span class="cp">]</span> CRITICAL object info:list index out of range
2014-12-11 20:50:55,684 trace_back.py<span class="cp">[</span><span class="nb">line</span><span class="p">:</span><span class="mi">34</span><span class="cp">]</span> CRITICAL Error Type:<span class="nt">&lt;type</span> <span class="err">&#39;</span><span class="na">exceptions</span><span class="err">.</span><span class="na">IndexError</span><span class="err">&#39;</span><span class="nt">&gt;</span>, Error information:list index out of range
2014-12-11 20:50:55,684 trace_back.py<span class="cp">[</span><span class="nb">line</span><span class="p">:</span><span class="mi">35</span><span class="cp">]</span> CRITICAL   File &quot;trace_back.py&quot;, line 27, in <span class="nt">&lt;module&gt;</span>
    f()
  File &quot;trace_back.py&quot;, line 14, in f
    return g()
  File &quot;trace_back.py&quot;, line 16, in g
    return h()
  File &quot;trace_back.py&quot;, line 19, in h
    return i()
  File &quot;trace_back.py&quot;, line 22, in i
    print gList<span class="cp">[</span><span class="mi">7</span><span class="cp">]</span>
</pre></div>


<h3>建议48：使用threading模块编写多线程程序</h3>
<p><strong>GIL</strong>(Global Interpreter Lock)全局解释器锁，是解释器用于同步线程的工具，使得任何时候只有一个线程在运行。GIL的存在使得Python多线程编程暂时无法利用多处理器的优势。但这不意味着我们要放弃多线程。
对于纯Python的代码也许使用多线程不能提高运行效率，但是以下几种情况，多线程仍然是比较好的解决方案：</p>
<ul>
<li>等待外部资源返回</li>
<li>建立反应灵活的用户界面</li>
<li>多用户应用程序</li>
</ul>
<p>Python为多线程编程提供了两个模块：</p>
<ol>
<li>thread</li>
<li>threading</li>
</ol>
<p>thread模块提供了多线程的底层支持模块，以低级方式来处理和控制线程，使用起来较为复杂；
threading模块基于thread进行封装，将线程操作对象化，在语言层面提供了丰富的特性。
因此，实际使用中推荐优先使用threading模块，因为：</p>
<ul>
<li>threading对同步原语的支持更为完善和丰富。如有Lock指令锁，还支持条件变量condition、信号量Semaphore等。</li>
<li>threading模块在主线程与子线程的交互上更为友好。threading中的join()方法能够阻塞当前上下文环境的线程，直到调用此方法的线程终止或者到达指定的timeout。利用该方法可以方便地控制主线程与子线程以及子线程之间的执行。</li>
</ul>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">threading</span><span class="o">,</span> <span class="nn">time</span><span class="o">,</span> <span class="nn">sys</span>
<span class="k">class</span> <span class="nc">test</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">delay</span><span class="p">):</span>
        <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delay</span> <span class="o">=</span> <span class="n">delay</span>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">print</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s"> delay for </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delay</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delay</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&#39;This is thread </span><span class="si">%s</span><span class="s"> on line </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">c</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&#39;End of thread </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
                <span class="k">break</span>
<span class="n">t1</span> <span class="o">=</span> <span class="n">test</span><span class="p">(</span><span class="s">&#39;Thread 1&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">t2</span> <span class="o">=</span> <span class="n">test</span><span class="p">(</span><span class="s">&#39;Thread 2&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">t1</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
<span class="k">print</span> <span class="s">&#39;Wait t1 to end&#39;</span>
<span class="n">t1</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
<span class="n">t2</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
<span class="k">print</span> <span class="s">&#39;End of main&#39;</span>
</pre></div>


<p>运行结果：
<img alt="threading_join" src="./imgs/threading_join.png" /></p>
<p>主线程main上使用t1的join()方法，主线程会等待t1结束后才继续运行后面的语句。线程t2的启动在join语句之后，t2一直等到t1退出后才会开始运行。</p>
<p>thread模块不支持守护进程。thread模块在主线程退出后，所有的主线程无论是否还在工作，都会被强制结束。threading模块，支持守护进程，可以通过setDaemon()来设定线程的daemon属性，当daemon属性为True时，表面主线程的退出可以不用等待子线程的完成（默认为False，即所有子线程结束后主线程才会结束）</p>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="k">def</span> <span class="nf">myfunc</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">delay</span><span class="p">):</span>
    <span class="k">print</span> <span class="s">&#39;I will calculate square of </span><span class="si">%s</span><span class="s"> after delay for </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">delay</span><span class="p">)</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>
    <span class="k">print</span> <span class="s">&#39;calculate begins...&#39;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">a</span><span class="o">*</span><span class="n">a</span>
    <span class="k">print</span> <span class="n">result</span>
    <span class="k">return</span> <span class="n">result</span>
<span class="n">t1</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">myfunc</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">t2</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">myfunc</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
<span class="k">print</span> <span class="n">t1</span><span class="o">.</span><span class="n">isDaemon</span><span class="p">()</span>
<span class="k">print</span> <span class="n">t2</span><span class="o">.</span><span class="n">isDaemon</span><span class="p">()</span>
<span class="n">t2</span><span class="o">.</span><span class="n">setDaemon</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
<span class="n">t1</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
<span class="n">t2</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</pre></div>


<p>运行结果：</p>
<p><img alt="threading" src="./imgs/threading.png" /></p>
<h3>建议49：使用Queue使多线程编程更安全</h3>
<p>线程间的同步互斥，线程间数据的共享等这些都是涉及线程安全要考虑的问题。</p>
<p>Python中的Queue提供了三种队列：</p>
<ul>
<li>Queue.Queue(maxsize)。FIFO</li>
<li>Queue.LifoQueue(maxsize)</li>
<li>Queue.PriorityQueue(maxsize)。优先级队列</li>
</ul>
<p>这三种队列支持以下几种方法：</p>
<ul>
<li>Queue.qsize()</li>
<li>empty()</li>
<li>full()</li>
<li>put(item, block, timeout  ):往队列中添加item元素，block为False的时候，若队列满则抛出Full异常，若block为True，则队列满一直等待有空位置，知道timeout时间后抛出异常。</li>
<li>put_nowait(item): 相当于block为False的put方法</li>
<li>get(block, timeout ): 与put类似的用法</li>
<li>get_nowait()</li>
<li>task_done()：发送信号表面入列任务已经完成，经常在消费者线程中使用</li>
<li>join()：阻塞直到队列中所有元素处理完毕</li>
</ul>
<p>Queue实现了多个生产者和多个消费者的队列，当多线程之间需要信息安全交换的时候特别有用。
需要注意的是Queue与collections.deque中的队列是不同的，前者主要用于不同线程之间的通信，它内部实现了线程的锁机制；而后者是数据结构上的概念。</p>
<p>例子：</p>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">Queue</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">urllib2</span>
<span class="k">class</span> <span class="nc">DownloadThread</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">queue</span><span class="p">):</span>
        <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queue</span> <span class="o">=</span> <span class="n">queue</span>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="k">print</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s">&quot;begin download&quot;</span> <span class="o">+</span> <span class="n">url</span> <span class="o">+</span> <span class="s">&quot;...&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">download_file</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">task_done</span><span class="p">()</span>
            <span class="k">print</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s">&quot; download completed!&quot;</span>
    <span class="k">def</span> <span class="nf">download_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">url</span><span class="p">):</span>
        <span class="n">urlhandler</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;.html&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                <span class="n">chunk</span> <span class="o">=</span> <span class="n">urlhandler</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">chunk</span><span class="p">:</span> <span class="k">break</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">urls</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;http://www.baidu.com&quot;</span><span class="p">,</span>
            <span class="s">&quot;http://www.google.com&quot;</span><span class="p">,</span>
            <span class="s">&quot;http://www.wengweitao.com&quot;</span>
            <span class="p">]</span>
    <span class="n">queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">DownloadThread</span><span class="p">(</span><span class="n">queue</span><span class="p">)</span>
        <span class="n">t</span><span class="o">.</span><span class="n">setDaemon</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">t</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">urls</span><span class="p">:</span>
        <span class="n">queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

    <span class="c"># wait for the queue to finish</span>
    <span class="n">queue</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</pre></div>


<p>结果：</p>
<h2><img alt="threading_queue" src="./imgs/threading_queue.png" /></h2>
<blockquote>
<p>Read from《<a href="http://book.douban.com/subject/25910544/">编写高质量代码：改善Python程序的91个建议</a>》</p>
</blockquote>
            </div><!-- /.entry-content -->
            <div class="comments">
              <h3>Comments</h3>
              <div id="disqus_thread"></div>
              <script type="text/javascript">
                var disqus_identifier = "bian-xie-gao-zhi-liang-pythondai-ma-3-ku.html";
                (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = 'http://wengwt.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                })();
              </script>
            </div>


        </div><!-- /.eleven.columns -->

<div class="three columns">

<!--
<h4>Pages</h4>

 <ul>
      <li><a href="/categories.html">分类</a></li>
      <li><a href="/tags.html">标签</a></li>
      <li><a href="/archives.html">归档</a></li>
      <li><a href="/pages/about-me.html">关于我</a></li>
  </ul>
-->

<h4>分类</h4>
<ul>
		<li><a href="http://www.wengweitao.com/category/du-shu-bi-ji.html">读书笔记</a></li>
		<li><a href="http://www.wengweitao.com/category/gong-ju.html">工具</a></li>
		<li><a href="http://www.wengweitao.com/category/ji-qi-xue-xi.html">机器学习</a></li>
		<li><a href="http://www.wengweitao.com/category/python.html">Python</a></li>
		<li><a href="http://www.wengweitao.com/category/sheng-huo.html">生活</a></li>
		<li><a href="http://www.wengweitao.com/category/suan-fa-yu-shu-ju-jie-gou.html">算法与数据结构</a></li>
</ul>

<!--
<h4>标签</h4>
<ul class="tagcloud">
        <li class="tag-1"><a href="http://www.wengweitao.com/tag/du-shu-bi-ji.html">读书笔记</a></li>
        <li class="tag-4"><a href="http://www.wengweitao.com/tag/ce-shi.html">测试</a></li>
        <li class="tag-4"><a href="http://www.wengweitao.com/tag/wan.html">玩</a></li>
        <li class="tag-4"><a href="http://www.wengweitao.com/tag/xiao-yuan.html">校园</a></li>
        <li class="tag-3"><a href="http://www.wengweitao.com/tag/ji-ben-gai-nian.html">基本概念</a></li>
        <li class="tag-4"><a href="http://www.wengweitao.com/tag/gong-ju.html">工具</a></li>
        <li class="tag-4"><a href="http://www.wengweitao.com/tag/ji-chu-gai-nian.html">基础概念</a></li>
        <li class="tag-4"><a href="http://www.wengweitao.com/tag/vim.html">Vim</a></li>
        <li class="tag-3"><a href="http://www.wengweitao.com/tag/mian-shi-ti.html">面试题</a></li>
        <li class="tag-1"><a href="http://www.wengweitao.com/tag/python.html">Python</a></li>
        <li class="tag-3"><a href="http://www.wengweitao.com/tag/jiao-cheng.html">教程</a></li>
</ul>
-->


<nav class="widget">
  <h4>社交</h4>
  <ul>
    <li><a href="http://weibo.com/u/2678027854">新浪微博</a></li>
    <li><a href="http://www.douban.com/people/wengwt/">豆瓣</a></li>
    <li><a href="http://www.zhihu.com/people/vita-49">知乎</a></li>
    <li><a href="https://github.com/nurnoch">Github</a></li>
    <li><a href="https://www.v2ex.com/member/wwttc">V2EX</a></li>
  </ul>
</nav>

<nav class="widget">
  <h4>友情链接</h4>
  <ul>
    <li><a href="http://netlab.pkusz.edu.cn/">互联网信息工程研发中心</a></li>
    <li><a href="http://www.houcj.net/">houcj's blog</a></li>
    <li><a href="http://www.rudy-yuan.net/">rundy-yuan's blog</a></li>
  </ul>
</nav>


</div> </div><!-- /.row -->


</section>

       </div><!-- /.row -->
    </div><!-- /.container -->


       <div class="container.nopad bg">

    
        <footer id="credits" class="row">
          <div class="seven columns left-center">

                   <address id="about" class="vcard body">
                    Proudly powered by  <a href="http://getpelican.com/">Pelican</a> and Theme by Gum © 2015 wwt
                    </address>
          </div>


          <div class="seven columns">
            <div class="row">
              <ul class="socbtns">





              </ul>
            </div>
          </div>
        </footer>

    </div>


<script type="text/javascript">
    var disqus_shortname = 'wengwt';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
  <script src="http://www.wengweitao.com/theme/js/libs/jquery-1.9.1.min.js"></script>
  <script src="http://www.wengweitao.com/theme/js/libs/gumby.min.js"></script>
  <script src="http://www.wengweitao.com/theme/js/plugins.js"></script>
</body>
</html>